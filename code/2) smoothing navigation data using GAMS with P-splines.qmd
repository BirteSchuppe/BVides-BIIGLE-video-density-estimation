---
title: "step 2: smoothing navigation data"
author: "Your Name"
date: "Today's Date"
format:
  html:
    toc: true
    number-sections: true
editor: 
  markdown: 
    wrap: sentence
---

## Setup

Before beginning, we will load necessary libraries.

```{r}


library(lubridate)
library(tsibble)
library(zoo) # for interpolations
library(plotly) # for interactive plots 
library(tidyverse)
library(magrittr) 
library(mgcv)



getwd() -> wd
# delete the "code" part of the pathway so that the rest of the path are not relative to the code directory
wd <- str_remove(wd, "/code") 

# set the working directory to the directory above "code"
setwd(wd)

# list the csv tables and print their names
list.files(paste0( wd,"/nav"), pattern = ".csv$" ) %>% 
# exclude the "arranged" pattern 
str_subset("smoothed", negate = T)  %>%  paste0("\n avialable CSV tables: \n",.) %>% cat

```

# Load data

open the table with time and xy positions, here maybe need to change/delete working direction???
(linked to my local drive) setwd("D:/PHD/ROV/ROV raw video density estimates/navigation_smoothing")

```{r}

navigation_file <- "Generic_navigation_generic.csv"
read_csv(paste0(wd,"/nav/",navigation_file) ) -> navigation

```

# set the time column

depending on the formate of your time column and The mood of Excel, you might need to change the time column to a datetime object if it is not done automatically

```{r}

 # fill the gaps in the shp file
# time management
navigation %>% 
# make the time column - if you have a data and a time column
  mutate(datetime = datetime) -> positions
# if you have a dmy_hms character string


# check that datetime is a datetime object
# if class of datetime is not "POSIXct" or "POSIXt" then convert it
if(!class(positions$datetime)[1] %in% c("POSIXct", "POSIXt"))  {
  print("setting datetime to POSIXt")
  positions %>%  mutate( datetime = dmy_hms(datetime)) -> positions
}

# check that the time column is in the right format
positions %>% 
  select(datetime) %>% glimpse

# make a time column of elapsed seconds based on column datetime, in case for if videotime (logged via ROV system) is not starting at 0
positions$elapsed_seconds <- as.numeric(difftime(positions$datetime, positions$datetime[1],units = "secs"))
```


# Smooth

*mgcv::gam* function specifically fits a Generalized additive model (GAM) using P-splines and smoothing parameter estimation method by REML

```{r}

# Smooth the track  

# Extract the variables to be smoothed from the navigation
t <- positions$elapsed_seconds # input variable is time in seconds
x <- positions$lon
y <- positions$lat
z <- positions$depth


### Fit a GAM with p-spline and smoothing parameter estimation method based on REML to each dimension. 

gam_east_gcv <- gam(x ~ s(t, bs = "ps", k=175),  method="REML")
gam_north_gcv <- gam(y ~ s(t, bs = "ps", k=175),  method="REML")
gam_depth_gcv <- gam(z ~ s(t, bs = "ps", k=175),   method="REML") 

### predict 
smooth_x <- predict(gam_east_gcv   ) %>% as.vector()

smooth_y <- predict(gam_north_gcv   ) %>% as.vector()

smooth_z <- predict(gam_depth_gcv   )%>% as.vector()



```


Assessment of basis dimension k. EDF and k index should be interpret carefully. For further reading, see mgcv help.

```{r}


# GAM smoothing model assessment
gam.check(gam_east_gcv) %>% print()
gam.check(gam_north_gcv) %>% print()
gam.check(gam_depth_gcv) %>% print()



```



# set frequency to 1s and predict postion at missing time stamps

using the GAM models to predict the position with a new set of time stamps at a given frequency (by default, 1s)

The zoo::na.approx function is part of the zoo package in R, which is designed for handling time series data and other ordered observations. The na.approx function is specifically used to approximate or interpolate missing values (NAs) in a numeric vector or time series. It assumes a linear relationship between the known data points surrounding the missing values to estimate them.

```{r}

# add the new coordinates to the table 
tibble( xsmoothed = smooth_x ,
        ysmoothed = smooth_y,
        depthsmoothed =smooth_z )  %>%
  bind_cols(positions,.)  -> smoothed_navigation
 
# create the missing time stamps so that you have a reading at each second 
smoothed_navigation %>%
  select(datetime, videotime,lon,lat, depth, elapsed_seconds,xsmoothed, ysmoothed,depthsmoothed ) %>% 
  add_row(. , datetime  = .$datetime[1] + 1  , .before = 2) %>% 
  as_tsibble(index = datetime) %>%
  fill_gaps() %>% # automatically creates the missing timestamps
  as_tibble() -> smoothed_navigation_filled

# make a new time vector for seconds
t2  <- as.numeric(difftime(smoothed_navigation_filled$datetime, smoothed_navigation_filled$datetime[1],units = "secs"))



# add t2 as videotime in seconds in 1 second intervals
smoothed_navigation_filled %>% 
 mutate(LON2 = predict(gam_east_gcv, newdata = data.frame(t = t2) ) %>% as.vector() ,
        LAT2 = predict(gam_north_gcv, newdata = data.frame(t = t2) ) %>% as.vector(), 
        DEPTH2 = predict(gam_depth_gcv, newdata = data.frame(t = t2) ) %>% as.vector(),
        videotime_interpolated = t2 %>% as.vector()
 ) -> interpolated_smoothed_navigation



# check that there are no NA left in LON2 or LAT2 or DEPTH2
if(any(is.na(interpolated_smoothed_navigation$LON2)) | any(is.na(interpolated_smoothed_navigation$LAT2)) | any(is.na(interpolated_smoothed_navigation$DEPTH2))) {
  print("There are NA values in LON2, LAT2 or DEPTH2")
} else {
  print("No NA values in LON2, LAT2 or DEPTH2. That's great")
}
 



```

# plot the interpolated smoothed track
```{r}


plot3d <- plot_ly() %>%
  # make smaller point size
  add_trace( data = interpolated_smoothed_navigation,
            x = ~lon, y = ~lat, z = ~(-depth),
            mode = "markers", type = "scatter3d", name = "un-smoothed ", marker = list(size = 3), 
            # display x y z and datetime when hovering over each point
            text = ~datetime%>% as.character(),
               hovertemplate = paste('<b>X</b>: %{x}',
                        '<br><b>Y</b>: %{y}',
                        '<br><b>Depth</b>: %{z}',
                        '<br><b>Time</b>: %{text}',sep = "" )
            ) %>%
    add_trace( data = interpolated_smoothed_navigation,
            x = ~lon, y = ~lat, z = ~(-depth),
            mode = "line", type = "scatter3d", name = "un-smoothed ", line = list(size = 4) ) %>%
  
  # use the smoothed XYZ
  add_trace(x = interpolated_smoothed_navigation$LON2, y = interpolated_smoothed_navigation$LAT2, z = - interpolated_smoothed_navigation$DEPTH2, mode = "lines", type = "scatter3d", name = " GAM smoothed with p-spline ") %>%
    add_trace(x = interpolated_smoothed_navigation$LON2, y = interpolated_smoothed_navigation$LAT2, z = - interpolated_smoothed_navigation$DEPTH2, mode = "markers", type = "scatter3d", name = "GAM smoothed with p-spline ",
               marker = list(size = 3) ) %>%
  

  
  # plot parameters 
  layout(title = "Difference of un-smoothed and smoothed & interpolated ROV transect",
         scene = list(xaxis = list(title = "Longitude"),
                      yaxis = list(title = "Latitude"),
                      zaxis = list(title = "Depth")))  


plot3d %>% print()  

library(htmlwidgets)


saveWidget(plot3d, paste0( "C:/Users/06169774/OneDrive - Nord universitet/BIIGLE-video-epifaunal-density-estimation/", "3D Navigation_steep3 ", ".html") )


```


# export

attach the smoothed XY and the interpolated depth to the navigation

```{r}


write_csv( interpolated_smoothed_navigation , paste0(wd,"/nav/smoothed_",navigation_file))   


```
